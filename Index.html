<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M√®o Phi√™u L∆∞u</title>
  <style>
    :root{--bg:#f0f6ff;--ground:#7bb26a;--cat:#ffb3b3;--accent:#ff6b81}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg)}
    .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:14px}
    canvas{background:linear-gradient(#dff0ff, #eef9ff);border-radius:12px;box-shadow:0 8px 18px rgba(20,30,60,.12);max-width:100%;height:auto}
    h1{margin:0;font-size:20px;text-align:center}
    .info{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center}
    .hud{display:flex;gap:12px;align-items:center}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:99}

    /* Touch pad */
    .touchpad{
      display:grid;
      grid-template-columns:60px 60px 60px;
      grid-template-rows:60px 60px;
      gap:8px;
      margin-top:14px;
      user-select:none;
    }
    .touchbtn{
      background:var(--accent);
      color:white;
      border:none;
      border-radius:12px;
      font-size:20px;
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      touch-action:none;
    }
    .touchbtn:active{background:#ff4d67}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>M√®o Phi√™u L∆∞u ‚Äî Thu th·∫≠p 5 sao ƒë·ªÉ k·∫øt game</h1>
    <div class="info">
      <div class="row hud">
        <div>üîä <span id="soundState" style="cursor:pointer">on</span></div>
        <div>‚≠ê <span id="score">0</span>/5</div>
      </div>
      <div style="margin-left:18px">ƒêi·ªÅu khi·ªÉn: ph√≠m m≈©i t√™n, WASD ho·∫∑c ch·∫°m n√∫t</div>
      <button class="btn" id="restartBtn">Ch∆°i l·∫°i</button>
    </div>
    <canvas id="game" width="720" height="420"></canvas>

    <!-- touchpad -->
    <div class="touchpad">
      <div></div>
      <button class="touchbtn" data-key="arrowup">‚¨ÜÔ∏è</button>
      <div></div>
      <button class="touchbtn" data-key="arrowleft">‚¨ÖÔ∏è</button>
      <button class="touchbtn" data-key="arrowdown">‚¨áÔ∏è</button>
      <button class="touchbtn" data-key="arrowright">‚û°Ô∏è</button>
    </div>
  </div>

  <div id="endOverlay" class="overlay" style="display:none;pointer-events:auto">
    <div style="background:rgba(255,255,255,0.98);backdrop-filter:blur(6px);padding:28px;border-radius:18px;box-shadow:0 10px 30px rgba(10,20,40,.2);text-align:center;max-width:520px">
      <h2 style="margin:4px 0 12px;font-size:28px">üéâ Ch√∫c m·ª´ng!</h2>
      <p style="margin:0 0 18px;font-size:18px">B·∫°n ƒë√£ gi√∫p m√®o thu th·∫≠p ƒë·ªß sao v√† m√®o c·∫£m th·∫•y r·∫•t vui</p>
      <div style="font-size:26px;color:var(--accent);font-weight:800">t·ªõ th√≠ch c·∫≠u l·∫Øm</div>
      <p style="margin-top:14px;color:#666">(Nh·∫•n Ch∆°i l·∫°i ƒë·ªÉ ch∆°i ti·∫øp)</p>
      <button id="closeEnd" class="btn" style="margin-top:12px">Ch∆°i l·∫°i</button>
    </div>
  </div>

  <audio id="bgMusic" src="./mp3/nhacgame.mp3" loop></audio>

  <script>
    const bgMusic = document.getElementById('bgMusic');
    bgMusic.volume = 0.5; // √¢m l∆∞·ª£ng nh·∫°c n·ªÅn
    bgMusic.preload = 'auto'; // t·∫£i tr∆∞·ªõc nh·∫°c n·ªÅn
    bgMusic.load();
    

    // ch·ªâ play nh·∫°c khi user click (ƒë·ªÉ tr√°nh autoplay block)
    document.body.addEventListener('click', () => {
      if(bgMusic.paused){
        bgMusic.play().catch(()=>{});
      }
    }, {once:true});

    bgMusic.addEventListener('play', ()=>{ document.getElementById('soundState').textContent='on'; });
    bgMusic.addEventListener('pause', ()=>{ document.getElementById('soundState').textContent='off'; });
    document.getElementById('soundState').addEventListener('click', ()=>{
      if(bgMusic.paused){ bgMusic.play().catch(()=>{}); }
      else{ bgMusic.pause(); }
    });

    // game code
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    const state = { score: 0, totalStars: 5, running: true };
    const player = { x: 80, y: H/2, w: 34, h: 34, speed: 200, vx:0, vy:0 };
    const dog = { x: W-120, y: H/2, w:36, h:36, speed: 100, dirX:-1 };
    let totalStars = 5;
    let stars = [];
    function placeStars(){
      stars = [];
      const padding = 40;
      for(let i=0;i<state.totalStars;i++){
        const x = padding + Math.random()*(W-padding*2);
        const y = padding + Math.random()*(H-padding*2);
        stars.push({x,y,r:12,got:false,phase:Math.random()*Math.PI*2});
      }
    }
    placeStars();

    const keys = {};
    window.addEventListener('keydown', e=>{keys[e.key.toLowerCase()]=true});
    window.addEventListener('keyup', e=>{keys[e.key.toLowerCase()]=false});

    // touch pad
    document.querySelectorAll('.touchbtn').forEach(btn=>{
      const k = btn.dataset.key;
      btn.addEventListener('touchstart', e=>{e.preventDefault(); keys[k]=true;});
      btn.addEventListener('touchend', e=>{e.preventDefault(); keys[k]=false;});
      btn.addEventListener('mousedown', ()=>{keys[k]=true;});
      btn.addEventListener('mouseup', ()=>{keys[k]=false;});
      btn.addEventListener('mouseleave', ()=>{keys[k]=false;});
    });

    function rectIntersect(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

    let audioCtx=null;
    function beep(freq=440,dur=0.08){
      try{
        if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        const o=audioCtx.createOscillator();
        const g=audioCtx.createGain();
        o.type='sine'; o.frequency.value=freq; g.gain.value=0.05;
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur);
        o.stop(audioCtx.currentTime+dur+0.02);
      }catch(e){}
    }

    let last = performance.now();
    function update(dt){
      player.vx = 0; player.vy = 0;
      if(keys['arrowleft']||keys['a']) player.vx = -1;
      if(keys['arrowright']||keys['d']) player.vx = 1;
      if(keys['arrowup']||keys['w']) player.vy = -1;
      if(keys['arrowdown']||keys['s']) player.vy = 1;
      if(player.vx!==0 && player.vy!==0){ player.vx*=Math.SQRT1_2; player.vy*=Math.SQRT1_2 }
      player.x += player.vx*player.speed*dt;
      player.y += player.vy*player.speed*dt;
      player.x = Math.max(10,Math.min(W-player.w-10, player.x));
      player.y = Math.max(10,Math.min(H-player.h-10, player.y));

      dog.x += dog.dirX * dog.speed * dt;
      if(dog.x < 80){ dog.dirX = 1 }
      if(dog.x > W-80){ dog.dirX = -1 }

      if(rectIntersect(player,dog)){
        player.x = 80; player.y = H/2; state.score = Math.max(0,state.score-1);
        document.getElementById('score').textContent = state.score;
        beep(200,0.2);
      }

      stars.forEach(s=>{
        const dx = (player.x+player.w/2) - s.x;
        const dy = (player.y+player.h/2) - s.y;
        const dist = Math.hypot(dx,dy);
        if(!s.got && dist < s.r + Math.max(player.w,player.h)/2 - 4){
          s.got = true;
          state.score++;
          document.getElementById('score').textContent = state.score;
          beep(880 - state.score*60, 0.08);
        }
      });

      if(state.score >= state.totalStars){ endGame(); }
      stars.forEach(s=> s.phase += dt*6);
    }

    function drawCat(x,y,w,h){
      ctx.save(); ctx.translate(x,y);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--cat') || '#ffb3b3';
      roundRect(ctx, 0, 6, w, h-8, 8, true, false);
      ctx.beginPath(); ctx.ellipse(w/2, 6, w*0.38, h*0.34, 0, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#ff8b8b';
      ctx.beginPath(); ctx.moveTo(6,2); ctx.lineTo(10,-10); ctx.lineTo(20,2); ctx.fill();
      ctx.beginPath(); ctx.moveTo(w-6,2); ctx.lineTo(w-10,-10); ctx.lineTo(w-20,2); ctx.fill();
      ctx.fillStyle='#222';
      ctx.beginPath(); ctx.ellipse(w*0.36,6,3,4,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(w*0.64,6,3,4,0,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='#6b3a3a'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.arc(w/2,10,6,0,Math.PI); ctx.stroke();
      ctx.restore();
    }
    function drawDog(x,y,w,h){
      ctx.save(); ctx.translate(x,y);
      ctx.fillStyle='#d6c08b'; roundRect(ctx,0,6,w,h-8,6,true,false);
      ctx.fillStyle='#b88b5e'; ctx.beginPath(); ctx.ellipse(w*0.7,6,4,5,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#222'; ctx.fillRect(w*0.3,6,4,4);
      ctx.restore();
    }
    function roundRect(ctx,x,y,w,h,r,fill,stroke){
      ctx.beginPath(); ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke();
    }
    function draw(){
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle='#e8f7e8'; ctx.fillRect(0,H-70,W,70);
      for(let i=0;i<6;i++){
        const bx = (i*130 + 40) % (W+60) - 40;
        ctx.fillStyle='#b6e0a6'; roundRect(ctx,bx,H-80,80,40,20,true,false);
      }
      stars.forEach(s=>{
        if(s.got) return;
        const pulse = 1 + Math.sin(s.phase)*0.12;
        ctx.save(); ctx.translate(s.x,s.y); ctx.scale(pulse,pulse);
        drawStar(ctx,0,0,5,10,5); ctx.restore();
      });
      drawDog(dog.x, dog.y, dog.w, dog.h);
      drawCat(player.x, player.y, player.w, player.h);
      ctx.fillStyle='#2a2a2a'; ctx.font='12px system-ui'; ctx.fillText('M√®o', player.x, player.y-8);
      stars.forEach((s,i)=>{
        if(s.got){
          const t = s.phase;
          const xx = s.x + Math.sin(t*2 + i)*6;
          const yy = s.y - (t%2)*12 - 10;
          drawHeart(ctx, xx, yy);
        }
      });
    }
    function drawStar(ctx,x,y,spikes,outerRadius,innerRadius){
      let rot = Math.PI/2*3, step = Math.PI/spikes;
      ctx.beginPath(); ctx.moveTo(x, y-outerRadius);
      for(let i=0;i<spikes;i++){
        let x1 = x + Math.cos(rot) * outerRadius;
        let y1 = y + Math.sin(rot) * outerRadius;
        ctx.lineTo(x1,y1); rot += step;
        let x2 = x + Math.cos(rot) * innerRadius;
        let y2 = y + Math.sin(rot) * innerRadius;
        ctx.lineTo(x2,y2); rot += step;
      }
      ctx.lineTo(x, y-outerRadius); ctx.closePath();
      ctx.fillStyle='#ffd166'; ctx.fill(); ctx.strokeStyle='#ffb84d'; ctx.stroke();
    }
    function drawHeart(ctx,x,y){
      ctx.save(); ctx.translate(x,y); ctx.scale(1.2,1.2);
      ctx.beginPath(); ctx.moveTo(0,6);
      ctx.bezierCurveTo(0,-2, -12,-2, -12,6);
      ctx.bezierCurveTo(-12,14, 0,20, 0,26);
      ctx.bezierCurveTo(0,20,12,14,12,6);
      ctx.bezierCurveTo(12,-2,0,-2,0,6);
      ctx.closePath();
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#ff6b81';
      ctx.fill(); ctx.restore();
    }

    function loop(ts){
      const dt = Math.min(0.035, (ts - last)/1000);
      last = ts;
      if(state.running){ update(dt); draw(); }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    function resetGame(){
      player.x = 80; player.y = H/2; state.score = 0;
      dog.x = W-120; dog.dirX = -1;
      document.getElementById('score').textContent = state.score;
      placeStars(); state.running = true;
      document.getElementById('endOverlay').style.display='none';
    }
    document.getElementById('restartBtn').addEventListener('click', resetGame);
    document.getElementById('closeEnd').addEventListener('click', resetGame);

    function endGame(){
      state.running = false;
      document.getElementById('endOverlay').style.display = 'flex';
      beep(1200,0.06); setTimeout(()=>beep(1400,0.08),80); setTimeout(()=>beep(1600,0.12),160);
    }

    canvas.addEventListener('click', ()=>{ if(!audioCtx) beep(440,0.03); });
  </script>
</body>
</html>
